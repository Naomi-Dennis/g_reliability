language: elixir
elixir:
  - 1.9

services:
  - postgresql

stages:
  - test
  - deploy
jobs:
  include:
    - name: "Test"
      stage: test
      script:
        - mix deps.get
        - mix test
    - name: "Deploy"
      if: (NOT type IN (pull_request)) AND (branch = master)
      stage: deploy
      env:
        - MIX_ENV=prod
      script:
        - mix deps.get
        - mix ecto.create
        - mix ecto.migrate
      deploy:
        provider: elasticbeanstalk
        access_key_id:
          secure: "Encrypted <access-key-id>=$AWS_SECRET_ID"
        secret_access_key:
          secure: "Encrypted <secret-access-key>=$AWS_SECRET_KEY"
        region: "us-east-1"
        app: "mind_the_gapp_prod"
        env: "mind-the-gapp-prod"
        bucket_name: "mind-the-gapp-backend-prod"
